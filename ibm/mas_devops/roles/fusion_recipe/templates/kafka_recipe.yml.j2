apiVersion: spp-data-protection.isf.ibm.com/v1alpha1
kind: Recipe
metadata:
  name: maximo-kafka-backup-restore-recipe
  namespace: '{{ fusion_namespace | lower }}'
spec:
  appType: maximo-amq-streams
  groups:
    - name: maximo-amq-streams-volumes
      type: volume
    - name: maximo-amq-streams-resources
      type: resource
    - backupRef: maximo-amq-streams-resources
      includedResourceTypes:
        - operatorgroups.operators.coreos.com
      name: maximo-amq-streams-operatorgroups
      type: resource
    - backupRef: maximo-amq-streams-resources
      includedResourceTypes:
        - subscriptions.operators.coreos.com
      name: maximo-amq-streams-subscriptions
      type: resource
    - backupRef: maximo-amq-streams-resources
      includedResourceTypes:
        - configmaps
        - secrets
      labelSelector: for-backup=true
      name: maximo-amq-streams-configmaps-secrets
      type: resource
    - backupRef: maximo-amq-streams-resources
      includedResourceTypes:
        - kafkas.kafka.strimzi.io
        - kafkausers.kafka.strimzi.io
      name: maximo-kafkas
      type: resource
  hooks:
    - chks:
        - condition: '{$.status.conditions[?(@.type=="Ready")].status} == {"True"}'
          name: statusReady
          onError: fail
          timeout: 1000
      labelSelector: for-backup=true
      name: maximo-kafkas-check
      namespace: '${GROUP.maximo-amq-streams-volumes.namespace}'
      onError: fail
      selectResource: kafka.strimzi.io/v1beta2/kafkas
      timeout: 120
      type: check
    - chks:
        - condition: '{$.status.conditions[?(@.type=="Ready")].status} == {"True"}'
          name: statusReady
          onError: fail
          timeout: 1000
      labelSelector: for-backup=true
      name: maximo-kafkausers-check
      namespace: '${GROUP.maximo-amq-streams-volumes.namespace}'
      onError: fail
      selectResource: kafka.strimzi.io/v1beta2/kafkausers
      timeout: 120
      type: check
    - chks:
        - condition: '{$.spec.replicas} == {$.status.readyReplicas}'
          name: replicasReady
          onError: fail
          timeout: 600
      labelSelector: olm.owner.kind=ClusterServiceVersion
      name: maximo-amq-streams-cluster-operator-check
      namespace: '${GROUP.maximo-amq-streams-volumes.namespace}'
      onError: fail
      selectResource: deployment
      timeout: 120
      type: check
    - labelSelector: 'rht.subcomp_t=infrastructure,strimzi.io/kind=cluster-operator'
      name: maximo-amq-streams-cluster-operator-pod-exec
      namespace: '${GROUP.maximo-amq-streams-volumes.namespace}'
      onError: fail
      ops:
        - command: |
            ["/bin/bash", "-c", "sleep 300"]
          container: strimzi-cluster-operator
          name: sleep-five-minutes
          timeout: 600
      selectResource: pod
      timeout: 180
      type: exec
  workflows:
    - failOn: any-error
      name: backup
      sequence:
        - group: maximo-amq-streams-resources
        - group: maximo-amq-streams-volumes
    - failOn: any-error
      name: restore
      sequence:
        - group: maximo-amq-streams-volumes
        - group: maximo-amq-streams-operatorgroups
        - group: maximo-amq-streams-subscriptions
        - hook: maximo-amq-streams-cluster-operator-check/replicasReady
        - group: maximo-amq-streams-configmaps-secrets
        - hook: maximo-amq-streams-cluster-operator-pod-exec/sleep-five-minutes
        - group: maximo-kafkas
        - hook: maximo-kafkas-check/statusReady
        - hook: maximo-kafkausers-check/statusReady